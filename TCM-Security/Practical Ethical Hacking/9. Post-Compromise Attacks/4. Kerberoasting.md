# Kerberoasting

Domain Controller (DC) also known as a 'key distribution centre' (KDC)

User will need to authenticate to the DC

When they do that
1. user will request a TGT (Ticket-Granting-Ticket) and provide/supply the NTLM hash (i.e. a valid user and password)
2. DC receives request and returns a TGT encrypted with a krbtgt (kerberos tgt) hash

Say we have an application server (could be SQL, could be AV, etc.), a service that we would like to access.
This service will have an SPN (Service Principle Name)

To access this service we need to first request a TGS (Ticket-Granting-Service ticket).

3. We present our TGT to the KDC and request a TGS
4. The server knows the server account hash and will encrypt that and sent it back to us 

> KDC does not know if we have access to the server or not
> It will provide to us the TGS with the server account hash
> This is where Kerberoasting starts

WE can get the hash, try to decrypt it or relay it!!

For us to connect to server:

5. Present TGS to the application server 
6. The server decrypts it using its application hash

![krbr-1](https://user-images.githubusercontent.com/87711310/209465391-b6fbf4e4-47d2-4fd9-b8ff-ba1e94ef8355.png)

## The attack

Will use another Impacket module
```
sudo GetUserSPNs.py marvel.local/fcastle:Password1 -dc-ip 10.10.10.6 -request
```

![krbr-2](https://user-images.githubusercontent.com/87711310/209465392-98bea4ed-2f3a-4ccd-b48b-a1134b6753d8.png)


We get the kbr5tgs hash for the SQL Service we set up before
copy and paste into file

Find which module to use
```
hashcat --help | grep Kerberos
```

![krbr-3](https://user-images.githubusercontent.com/87711310/209465393-71c2b29b-78bf-4df0-8e35-87d222909767.png)

We will use the Kerberos 5 TGS-REP, etype 23 module (13100)

```
sudo hashcat -m 13100 hashes.txt rockyou.txt -O
```

Will find SQL Service domain password (MYpass123!)

![krbr-4](https://user-images.githubusercontent.com/87711310/209465394-fa6d6a12-3a44-45d7-805a-d95d8682b93d.png)

Which we knew already from our previous attacks (eg. ntlmxrelay.py)

Once you get a credential at all, you can try Kerberoasting

## Kerberoasting Mitigation

We are abusing a feature so there is nothing to defent against it other than:
- strong passwords (not just long)
- least privilege
	- do NOT make domain accounts domain admins
	- do NOT make service accounts administrators

