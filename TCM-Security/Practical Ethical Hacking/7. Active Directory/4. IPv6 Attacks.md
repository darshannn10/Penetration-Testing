# IPv6 Attacks

Machines typically run on IPv4 on the network
Chances are the network is not even utilising IPv6
i.e. IPv6 might be on but we are utilising IPv4

If we are using IPv4 but IPv6 is turned on, no-one is doing DNS for IPv6. 
Can set up an attacker machine and will listen for all IPv6 messages coming through 
- we can pretend we are i.e. spoof the DNS
- like that, we can get authentication to the DC via LDAP or SMB
- can do that e.g. when a machine reboots and we capture the IPv6 information (then by spoofing we get DC info)
- that will come to us in the form of NTLM, and we relay that to the DC (i.e. the LDAP or SMB)

Will use **Mitm6** (Man in the middle) to do so in combination with ntlmrelayx. It will create a new account for us. 

We need to use Mitm6 and set up LDAP

After we set up LDAP on add certificate on DC

Now run mitm6
```
sudo mitm6 -d marvel.local
```
![ivp6-attack-1](https://user-images.githubusercontent.com/87711310/209447065-daac17c8-64ed-4105-b610-3a7d1cc01d4f.png)

Start ntlmrelayx
```
sudo ntlmrelayx.py -6 -t ldaps://10.10.10.6 -wh fakewpad.marvel.local -l lootme
```
![ivp6-attack-2](https://user-images.githubusercontent.com/87711310/209447067-dc0c0238-8bcd-4611-a6cd-3548c9bdcd3c.png)

Can find "loot" automatically generated in the folder
![ivp6-attack-3](https://user-images.githubusercontent.com/87711310/209447056-05b860dc-5391-42fc-920f-22d7b0cf2d6b.png)

e.g. check out a form
```
firefox domain_users_by_group.html
```
![ivp6-attack-4](https://user-images.githubusercontent.com/87711310/209447057-9b54a189-29cb-4881-a6f8-0ebc4e021364.png)

![ivp6-attack-5](https://user-images.githubusercontent.com/87711310/209447058-899d62ba-0fe9-415d-9d6c-5e1768a9c039.png)

We see that once we have logged in FC with MARVEL\Administrator credentials, mitm6 manages to get access (because of the LDAP relay) and even create a new user for us:

![ivp6-attack-6](https://user-images.githubusercontent.com/87711310/209447059-ffb8016c-a735-4c31-af7e-7122bc56a3e9.png)

![ivp6-attack-7](https://user-images.githubusercontent.com/87711310/209447060-df2c48c1-e870-483e-99f4-a9d11c3f1a34.png)

Can see the created user from the DC

![ivp6-attack-8](https://user-images.githubusercontent.com/87711310/209447063-19f5db2c-84f6-4b4f-978a-365290feaad3.png)


Finally, we see a recovery script auto generated by mitm6 to recover the previous setup before our invasion

![ivp6-attack-9](https://user-images.githubusercontent.com/87711310/209447064-80b698a3-da35-42d9-bc10-80ef9068b7ef.png)

***

## IPv6 Attacks Mitigation

IPv6 poisoning abuses the fact that Windows queries for an IPv6 address even in IPv4-only environments.

If we don't use IPv6 internally, the safest way to prevent mitm6 is to block DHCPv6 traffic and incoming router advertisements in Windows Firewall via Group Policy. Disabling IPv6 entirely may have unwanted side effects. 

Setting the following predefined rules to **Block** instead of **Allow**, prevents the attack from working:
- (Inbound) Core Networking - Dynamic Host Configuration Protocol for IPv6 (DHCPV6-In)
- (Inbound) Core Networking - Router Advertisment (ICMPv6-In)
- (Outbound) Core Networking - Dynamic Host Configuration Protocol for IPv6 (DHCPV6-Out)

If WPAD (Web Proxy Auto Discovery) is not in use internally, disable it via Group Policy and by disabling the WinHttpAutoProxySvc service

Relaying to LDAP and LDAPS can only be mitigated by enabling both LDAP signing and LDAP channel binding

Consider adding Administrative users to the 'Protected Users' group or marking them as 'Account is sensitive and cannot be delegated', which will prevent any impersonation of that user via delegation 
